name: 'CI/CD Pipeline'

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]

jobs:
    lint-and-test:
        runs-on: ubuntu-latest

        steps:
            - name: Check out repository
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: '3.12'
                  cache: 'pip'

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -e .[dev]
                  pip install requests python-dotenv

            - name: Run Ruff linter
              run: ruff check .

            - name: Run Ruff formatter check
              run: ruff format --check .

            - name: Run Bandit security checks
              run: bandit -r . -c pyproject.toml

            - name: Run pytest
              run: PYTHONPATH=. pytest tests/ -v --tb=short

            - name: Check database schema
              run: |
                  python -c "
                  from backend.database import init_database, get_db_path
                  import os
                  # Initialize test database
                  init_database()
                  # Verify database exists
                  assert os.path.exists(get_db_path()), 'Database file not created'
                  print('✅ Database schema validation passed')
                  "

    type-check:
        runs-on: ubuntu-latest

        steps:
            - name: Check out repository
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: '3.12'

            - name: Install mypy (optional type checking)
              run: |
                  python -m pip install --upgrade pip
                  pip install mypy
              continue-on-error: true

            - name: Run mypy type checker
              run: mypy backend/ --ignore-missing-imports --no-strict-optional
              continue-on-error: true

    code-quality:
        runs-on: ubuntu-latest

        steps:
            - name: Check out repository
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: '3.12'

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -e .[dev]

            - name: Check for TODO/FIXME comments
              run: |
                  echo "Scanning for TODO/FIXME comments..."
                  grep -rn "TODO\|FIXME" --include="*.py" backend/ components/ routes/ services/ || echo "No TODO/FIXME found"

            - name: Check code complexity
              run: |
                  pip install radon
                  radon cc backend/ components/ routes/ services/ -a -nb
              continue-on-error: true

    dependency-check:
        runs-on: ubuntu-latest

        steps:
            - name: Check out repository
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: '3.12'

            - name: Install pip-audit
              run: python -m pip install pip-audit

            - name: Check for security vulnerabilities in dependencies
              run: |
                  pip install -e .
                  pip-audit --desc
              continue-on-error: true

    integration-test:
        runs-on: ubuntu-latest
        needs: [lint-and-test]

        steps:
            - name: Check out repository
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: '3.12'

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -e .[dev]
                  pip install requests python-dotenv

            - name: Test ETL script (dry run)
              env:
                  UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
                  UNSPLASH_USERNAME: joaohfrodrigues
              run: |
                  # Run ETL in test mode to verify it works
                  python backend/etl.py --test
                  # Verify database was created and populated
                  python -c "
                  from backend.db_service import get_database_stats
                  stats = get_database_stats()
                  assert stats['total_photos'] > 0, 'No photos synced'
                  print(f'✅ ETL test passed: {stats[\"total_photos\"]} photos synced')
                  "
              continue-on-error: true

            - name: Test API endpoints
              run: |
                  pip install httpx
                  python -c "
                  from backend.db_service import get_latest_photos, get_all_collections

                  # Test get_latest_photos
                  photos, has_more = get_latest_photos(page=1, per_page=10)
                  assert len(photos) > 0, 'No photos returned'
                  print(f'✅ get_latest_photos returned {len(photos)} photos')

                  # Test get_all_collections
                  collections = get_all_collections()
                  assert len(collections) > 0, 'No collections returned'
                  print(f'✅ get_all_collections returned {len(collections)} collections')
                  "

    build-check:
        runs-on: ubuntu-latest
        needs: [lint-and-test]

        steps:
            - name: Check out repository
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: '3.12'

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -e .

            - name: Verify package installation
              run: |
                  python -c "import backend; print('✅ Backend module imports successfully')"
                  python -c "import components; print('✅ Components module imports successfully')"
                  python -c "import services; print('✅ Services module imports successfully')"
                  python -c "import routes; print('✅ Routes module imports successfully')"

            - name: Check for import errors
              run: |
                  python -c "
                  import sys
                  try:
                      from backend.database import init_database
                      from backend.db_service import get_latest_photos
                      from backend.etl import sync_photos
                      print('✅ All backend imports successful')
                  except ImportError as e:
                      print(f'❌ Import error: {e}')
                      sys.exit(1)
                  "

    notify:
        runs-on: ubuntu-latest
        needs: [lint-and-test, code-quality, build-check]
        if: always()

        steps:
            - name: Check workflow status
              run: |
                  echo "Workflow completed"
                  echo "Lint and Test: ${{ needs.lint-and-test.result }}"
                  echo "Code Quality: ${{ needs.code-quality.result }}"
                  echo "Build Check: ${{ needs.build-check.result }}"
